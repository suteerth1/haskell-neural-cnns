<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<title>NNet.hs</title>
</head>
<head>
<link type='text/css' rel='stylesheet' href='liquid.css' />
</head>

<body>
<hr>
Put mouse over identifiers to see inferred types
<pre><span class=hs-linenum>  1: </span><span class='hs-keyword'>module</span> <span class='hs-conid'>NNet</span> <span class='hs-keyword'>where</span>
<span class=hs-linenum>  2: </span>
<span class=hs-linenum>  3: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Codec</span><span class='hs-varop'>.</span><span class='hs-conid'>Compression</span><span class='hs-varop'>.</span><span class='hs-conid'>GZip</span> <span class='hs-layout'>(</span><span class='hs-varid'>decompress</span><span class='hs-layout'>)</span>
<span class=hs-linenum>  4: </span><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Lazy</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS</span>
<span class=hs-linenum>  5: </span>
<span class=hs-linenum>  6: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
<span class=hs-linenum>  7: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<span class=hs-linenum>  8: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Functor</span>
<span class=hs-linenum>  9: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>
<span class=hs-linenum> 10: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<span class=hs-linenum> 11: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Random</span>
<span class=hs-linenum> 12: </span>
<span class=hs-linenum> 13: </span><span class='hs-keyword'>type</span> <span class='hs-conid'>Brain</span> <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 14: </span><span class='hs-comment'>-- Makes a new brain with the array of ints as the</span>
<span class=hs-linenum> 15: </span><span class='hs-definition'>newBrain</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Brain</span> <span class='hs-comment'>-- IO [([Float], [[Float]])]</span>
<span class=hs-linenum> 16: </span>
<span class=hs-linenum> 17: </span><span class='hs-comment'>-- Boxâ€“Muller transform</span>
<span class=hs-linenum> 18: </span><span class='hs-definition'>gauss</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Float</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Float</span>
<span class=hs-linenum> 19: </span>
<span class=hs-linenum> 20: </span><span class='hs-comment'>-- This is to move from layer to layer</span>
<span class=hs-linenum> 21: </span><span class='hs-definition'>zLayer</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 22: </span><span class='hs-definition'>feed</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 23: </span><span class='hs-definition'>revaz</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 24: </span><span class='hs-definition'>deltas</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 25: </span><span class='hs-definition'>learn</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 26: </span>
<span class=hs-linenum> 27: </span><span class='hs-keyword'>{-@</span><span class='hs-definition'>measure</span> <span class='hs-varid'>lenght'</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 28: </span><span class='hs-keyword'>{-@</span><span class='hs-definition'>lenght'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span><span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 29: </span><span class='hs-definition'>lenght'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<span class=hs-linenum> 30: </span><span class='hs-definition'>lenght'</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<span class=hs-linenum> 31: </span><span class='hs-definition'>lenght'</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>lenght'</span> <span class='hs-varid'>t</span>
<span class=hs-linenum> 32: </span>
<span class=hs-linenum> 33: </span>
<span class=hs-linenum> 34: </span><span class='hs-definition'>gauss</span> <span class='hs-varid'>scale</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum> 35: </span>  <span class='hs-varid'>x1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomIO</span>
<span class=hs-linenum> 36: </span>  <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomIO</span>
<span class=hs-linenum> 37: </span>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>scale</span> <span class='hs-varop'>*</span> <span class='hs-varid'>sqrt</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>2</span> <span class='hs-varop'>*</span> <span class='hs-varid'>log</span> <span class='hs-varid'>x1</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span> <span class='hs-varop'>*</span> <span class='hs-varid'>pi</span> <span class='hs-varop'>*</span> <span class='hs-varid'>x2</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 38: </span>
<span class=hs-linenum> 39: </span><span class='hs-definition'>newBrain</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>replicate</span> <span class='hs-num'>1</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span>
<span class=hs-linenum> 40: </span>  <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gauss</span> <span class='hs-num'>0.01</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span>
<span class=hs-linenum> 41: </span>
<span class=hs-linenum> 42: </span><span class='hs-definition'>relu</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span> <span class='hs-num'>0</span>
<span class=hs-linenum> 43: </span><span class='hs-definition'>relu'</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<span class=hs-linenum> 44: </span>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<span class=hs-linenum> 45: </span>
<span class=hs-linenum> 46: </span><span class='hs-keyword'>{-@</span><span class='hs-definition'>zLayer</span> <span class='hs-keyglyph'>::</span> <span class=hs-error><span class='hs-keyglyph'>[</span></span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{b:</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyword'>| lenght' a == lenght' b}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 47: </span><span class='hs-definition'>zLayer</span> <span class='hs-keyword'>as</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sum</span> <span class='hs-varop'>.</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>wvs</span>
<span class=hs-linenum> 48: </span>
<span class=hs-linenum> 49: </span><span class='hs-definition'>feed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>relu</span> <span class='hs-varop'>&lt;$&gt;</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>zLayer</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 50: </span>
<span class=hs-linenum> 51: </span><span class='hs-definition'>revaz</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>av</span><span class='hs-conop'>:</span><span class='hs-varid'>avt</span><span class='hs-layout'>,</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span>
<span class=hs-linenum> 52: </span>  <span class='hs-varid'>zs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zLayer</span> <span class='hs-varid'>av</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wms</span><span class='hs-layout'>)</span> <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>relu</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zs'</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-varid'>av</span><span class='hs-conop'>:</span><span class='hs-varid'>avt</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>zs'</span><span class='hs-conop'>:</span><span class='hs-varid'>zs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>xs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 53: </span>
<span class=hs-linenum> 54: </span><span class='hs-keyword'>{-@</span><span class='hs-definition'>dCost</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-definition'>a</span><span class='hs-keyword'>| v &lt;= 0}</span><span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 55: </span><span class='hs-definition'>dCost</span> <span class='hs-varid'>a</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>y</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<span class=hs-linenum> 56: </span>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-</span> <span class='hs-varid'>y</span>
<span class=hs-linenum> 57: </span>
<span class=hs-linenum> 58: </span><span class='hs-definition'>deltas</span> <span class='hs-varid'>xv</span> <span class='hs-varid'>yv</span> <span class='hs-varid'>layers</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<span class=hs-linenum> 59: </span>  <span class='hs-layout'>(</span><span class='hs-varid'>avs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>av</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>zv</span><span class='hs-conop'>:</span><span class='hs-varid'>zvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>revaz</span> <span class='hs-varid'>xv</span> <span class='hs-varid'>layers</span>
<span class=hs-linenum> 60: </span>  <span class='hs-varid'>delta0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>dCost</span> <span class='hs-varid'>av</span> <span class='hs-varid'>yv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>relu'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zv</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 61: </span>  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>avs</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>transpose</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>layers</span><span class='hs-layout'>)</span> <span class='hs-varid'>zvs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>delta0</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<span class=hs-linenum> 62: </span>    <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dvs</span>
<span class=hs-linenum> 63: </span>    <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>wm</span><span class='hs-conop'>:</span><span class='hs-varid'>wms</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zv</span><span class='hs-conop'>:</span><span class='hs-varid'>zvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>dvs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>dv</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>wms</span> <span class='hs-varid'>zvs</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-varid'>dvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<span class=hs-linenum> 64: </span>      <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sum</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span> <span class='hs-varid'>row</span> <span class='hs-varid'>dv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>row</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wm</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>relu'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zv</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 65: </span>
<span class=hs-linenum> 66: </span><span class='hs-definition'>eta</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0.002</span>
<span class=hs-linenum> 67: </span>
<span class=hs-linenum> 68: </span><span class='hs-definition'>descend</span> <span class='hs-varid'>av</span> <span class='hs-varid'>dv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-layout'>)</span> <span class='hs-varid'>av</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>eta</span> <span class='hs-varop'>*</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dv</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 69: </span>
<span class=hs-linenum> 70: </span><span class='hs-definition'>learn</span> <span class='hs-varid'>xv</span> <span class='hs-varid'>yv</span> <span class='hs-varid'>layers</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>avs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deltas</span> <span class='hs-varid'>xv</span> <span class='hs-varid'>yv</span> <span class='hs-varid'>layers</span>
<span class=hs-linenum> 71: </span>  <span class='hs-keyword'>in</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>descend</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>layers</span><span class='hs-layout'>)</span> <span class='hs-varid'>dvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<span class=hs-linenum> 72: </span>    <span class='hs-varid'>zipWith3</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>wvs</span> <span class='hs-varid'>av</span> <span class='hs-varid'>dv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>wv</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>descend</span> <span class='hs-varid'>wv</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>av</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>wvs</span> <span class='hs-varid'>dv</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 73: </span>      <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>layers</span><span class='hs-layout'>)</span> <span class='hs-varid'>avs</span> <span class='hs-varid'>dvs</span>
<span class=hs-linenum> 74: </span>
<span class=hs-linenum> 75: </span><span class='hs-definition'>getImage</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>.</span> <span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-varid'>index</span> <span class='hs-varid'>s</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>*</span><span class='hs-num'>28</span><span class='hs-varop'>^</span><span class='hs-num'>2</span> <span class='hs-varop'>+</span> <span class='hs-num'>16</span> <span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-num'>28</span><span class='hs-varop'>^</span><span class='hs-num'>2</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 76: </span><span class='hs-definition'>getX</span>     <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>/</span> <span class='hs-num'>256</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getImage</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span>
<span class=hs-linenum> 77: </span><span class='hs-definition'>getLabel</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-varid'>index</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-num'>8</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 78: </span><span class='hs-definition'>getY</span>     <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromEnum</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLabel</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-num'>9</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 79: </span>
<span class=hs-linenum> 80: </span><span class='hs-definition'>render</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>" .:oO@"</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>s</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>n</span> <span class='hs-varop'>*</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>256</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 81: </span>
<span class=hs-linenum> 82: </span><span class='hs-definition'>train</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Brain</span> <span class='hs-comment'>-- IO [([Float], [[Float]])]</span>
<span class=hs-linenum> 83: </span><span class='hs-definition'>train</span> <span class='hs-varid'>imgF</span> <span class='hs-varid'>lblF</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum> 84: </span>  <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newBrain</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>784</span><span class='hs-layout'>,</span> <span class='hs-num'>30</span><span class='hs-layout'>,</span> <span class='hs-num'>10</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 85: </span>  <span class='hs-keyglyph'>[</span><span class='hs-varid'>trainI</span><span class='hs-layout'>,</span> <span class='hs-varid'>trainL</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>decompress</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-varid'>readFile</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>imgF</span><span class='hs-layout'>,</span> <span class='hs-varid'>lblF</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 86: </span>  <span class='hs-keyword'>let</span>
<span class=hs-linenum> 87: </span>    <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scanl</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>b</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>learn</span> <span class='hs-layout'>(</span><span class='hs-varid'>getX</span> <span class='hs-varid'>trainI</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getY</span> <span class='hs-varid'>trainL</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>[</span>
<span class=hs-linenum> 88: </span>     <span class='hs-keyglyph'>[</span>   <span class='hs-num'>0</span><span class='hs-keyglyph'>..</span> <span class='hs-num'>999</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 89: </span>     <span class='hs-keyglyph'>[</span><span class='hs-num'>1000</span><span class='hs-keyglyph'>..</span><span class='hs-num'>2999</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 90: </span>     <span class='hs-keyglyph'>[</span><span class='hs-num'>3000</span><span class='hs-keyglyph'>..</span><span class='hs-num'>5999</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<span class=hs-linenum> 91: </span>     <span class='hs-keyglyph'>[</span><span class='hs-num'>6000</span><span class='hs-keyglyph'>..</span><span class='hs-num'>9999</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 92: </span>    <span class='hs-varid'>smart</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>last</span> <span class='hs-varid'>bs</span>
<span class=hs-linenum> 93: </span>  <span class='hs-varid'>return</span> <span class='hs-varid'>smart</span>
<span class=hs-linenum> 94: </span>
<span class=hs-linenum> 95: </span><span class='hs-definition'>testNN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Brain</span> <span class='hs-comment'>{-IO [([Float], [[Float]])]-}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span>
<span class=hs-linenum> 96: </span><span class='hs-definition'>testNN</span> <span class='hs-varid'>imgF</span> <span class='hs-varid'>lblF</span> <span class='hs-varid'>brain</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum> 97: </span>  <span class='hs-varid'>smart</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>brain</span>
<span class=hs-linenum> 98: </span>  <span class='hs-keyglyph'>[</span><span class='hs-varid'>testI</span><span class='hs-layout'>,</span> <span class='hs-varid'>testL</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>decompress</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-varid'>readFile</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>imgF</span><span class='hs-layout'>,</span> <span class='hs-varid'>lblF</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum> 99: </span>  <span class='hs-keyword'>let</span>
<span class=hs-linenum>100: </span>    <span class='hs-varid'>bestOf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>maximumBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>zip</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>101: </span>    <span class='hs-varid'>answers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getLabel</span> <span class='hs-varid'>testL</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-num'>9999</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>102: </span>    <span class='hs-varid'>gusses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bestOf</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>feed</span> <span class='hs-layout'>(</span><span class='hs-varid'>getX</span> <span class='hs-varid'>testI</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>smart</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-num'>9999</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>103: </span>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromEnum</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>gusses</span> <span class='hs-varid'>answers</span><span class='hs-layout'>)</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>100</span>
<span class=hs-linenum>104: </span>
<span class=hs-linenum>105: </span><span class='hs-definition'>writeNNToFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Brain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Brain</span>
<span class=hs-linenum>106: </span><span class='hs-definition'>writeNNToFile</span> <span class='hs-varid'>fName</span> <span class='hs-varid'>brain</span><span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>107: </span>  <span class='hs-varid'>smart</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>brain</span>
<span class=hs-linenum>108: </span>  <span class='hs-varid'>writeFile</span> <span class='hs-varid'>fName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>show</span> <span class='hs-varid'>smart</span>
<span class=hs-linenum>109: </span>  <span class='hs-varid'>return</span> <span class='hs-varid'>smart</span>
<span class=hs-linenum>110: </span>
<span class=hs-linenum>111: </span><span class='hs-definition'>readNNFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Brain</span>
<span class=hs-linenum>112: </span><span class='hs-definition'>readNNFile</span> <span class='hs-varid'>fName</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>113: </span>  <span class='hs-varid'>sSmart</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readFile</span> <span class='hs-varid'>fName</span>
<span class=hs-linenum>114: </span>  <span class='hs-keyword'>let</span> <span class='hs-varid'>smart</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>read</span> <span class='hs-varid'>sSmart</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Float</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>115: </span>  <span class='hs-varid'>return</span> <span class='hs-varid'>smart</span>
<span class=hs-linenum>116: </span>  
</pre>
</body>
</html>